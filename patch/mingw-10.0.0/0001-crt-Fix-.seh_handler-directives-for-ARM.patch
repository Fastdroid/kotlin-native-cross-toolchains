From 08fd589f4420f6a643eefc260e02194dcf8ddc95 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Martin=20Storsj=C3=B6?= <martin@martin.st>
Date: Sat, 7 May 2022 00:13:12 +0300
Subject: [PATCH] crt: Fix .seh_handler directives for ARM
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The latest LLVM from git supports generating SEH unwind info on ARM.

In ARM assembly, '@' is a comment character. Therefore, the use
of that character in .seh_handler directives doesn't work on ARM.

LLVM now accepts '%' as an alternative for '@' in .seh_handler
directives [1], consistent with how GAS explains using '%' as an
alternative for '@' in such cases [2]. (However, GAS doesn't
support '%' as alternative char in .seh_handler on x86_64, not
yet at least.)

[1] https://github.com/llvm/llvm-project/commit/6b75a3523ffd79bc03265469aeeedab26079026e
[2] https://sourceware.org/binutils/docs/as/Section.html#Section

Signed-off-by: Martin Storsj√∂ <martin@martin.st>
---
 mingw-w64-crt/crt/crtexe.c                   | 8 ++++++++
 mingw-w64-libraries/winpthreads/src/thread.c | 4 ++++
 2 files changed, 12 insertions(+)

diff --git a/mingw-w64-crt/crt/crtexe.c b/mingw-w64-crt/crt/crtexe.c
index c6d4316..65303f8 100644
--- a/mingw-w64-crt/crt/crtexe.c
+++ b/mingw-w64-crt/crt/crtexe.c
@@ -177,7 +177,11 @@ int WinMainCRTStartup (void)
 #ifdef SEH_INLINE_ASM
   asm ("\tnop\n"
     "\t.l_endw: nop\n"
+#ifdef __arm__
+    "\t.seh_handler __C_specific_handler, %except\n"
+#else
     "\t.seh_handler __C_specific_handler, @except\n"
+#endif
     "\t.seh_handlerdata\n"
     "\t.long 1\n"
     "\t.rva .l_startw, .l_endw, _gnu_exception_handler ,.l_endw\n"
@@ -203,7 +207,11 @@ int mainCRTStartup (void)
 #ifdef SEH_INLINE_ASM
   asm ("\tnop\n"
     "\t.l_end: nop\n"
+#ifdef __arm__
+    "\t.seh_handler __C_specific_handler, %except\n"
+#else
     "\t.seh_handler __C_specific_handler, @except\n"
+#endif
     "\t.seh_handlerdata\n"
     "\t.long 1\n"
     "\t.rva .l_start, .l_end, _gnu_exception_handler ,.l_end\n"
diff --git a/mingw-w64-libraries/winpthreads/src/thread.c b/mingw-w64-libraries/winpthreads/src/thread.c
index e3edbae..3a9c6ed 100644
--- a/mingw-w64-libraries/winpthreads/src/thread.c
+++ b/mingw-w64-libraries/winpthreads/src/thread.c
@@ -1521,7 +1521,11 @@ pthread_create_wrapper (void *args)
       /* Provide to this thread a default exception handler.  */
       #ifdef __SEH__
 	asm ("\t.tl_start:\n"
+#ifdef __arm__
+	  "\t.seh_handler __C_specific_handler, %except\n"
+#else
 	  "\t.seh_handler __C_specific_handler, @except\n"
+#endif
 	  "\t.seh_handlerdata\n"
 	  "\t.long 1\n"
 	  "\t.rva .tl_start, .tl_end, _gnu_exception_handler ,.tl_end\n"
